name: ğŸš€ çƒæ¢ç¤¾ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deploy to environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  FLUTTER_VERSION: '3.32.4'
  DENO_VERSION: '2.0.0'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ğŸ¦• Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: ${{ env.DENO_VERSION }}
    
    - name: ğŸ“¦ Get Flutter dependencies
      run: flutter pub get
    
    - name: ğŸ” Analyze Flutter code
      run: flutter analyze --fatal-infos
    
    - name: ğŸ§ª Check Deno code
      run: |
        cd backend
        deno check --unstable-temporal-api mod.ts
        deno lint
    
    - name: ğŸ“ Check formatting
      run: |
        flutter format --set-exit-if-changed lib/
        cd backend && deno fmt --check

  # Flutteræµ‹è¯•
  flutter-test:
    name: ğŸ§ª Flutter Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ğŸ§ª Run tests
      run: flutter test --coverage
    
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        flags: flutter
        name: flutter-coverage
        fail_ci_if_error: false

  # Denoæµ‹è¯•
  deno-test:
    name: ğŸ¦• Deno Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦• Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: ${{ env.DENO_VERSION }}
    
    - name: ğŸ§ª Run backend tests
      run: |
        cd backend
        deno test --allow-net --allow-read --allow-env --coverage
    
    - name: ğŸ“Š Generate coverage report
      run: |
        cd backend
        deno coverage --lcov > coverage.lcov
    
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: backend/coverage.lcov
        flags: deno
        name: deno-coverage
        fail_ci_if_error: false

  # Webæ„å»º
  build-web:
    name: ğŸŒ Build Web
    runs-on: ubuntu-latest
    needs: [flutter-test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ğŸŒ Build for web
      run: flutter build web --release --no-tree-shake-icons
    
    - name: ğŸ“ Upload web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web/
        retention-days: 30

  # Androidæ„å»º
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [flutter-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ğŸ¤– Build Android APK
      run: flutter build apk --release
    
    - name: ğŸ¤– Build Android AAB
      run: flutter build appbundle --release
    
    - name: ğŸ“ Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
        retention-days: 30

  # iOSæ„å»º (ä»…åœ¨macOSä¸Š)
  build-ios:
    name: ğŸ Build iOS
    runs-on: macos-latest
    needs: [flutter-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ğŸ Build iOS (no code sign)
      run: flutter build ios --release --no-codesign
    
    - name: ğŸ“ Upload iOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: build/ios/iphoneos/Runner.app
        retention-days: 30

  # macOSæ„å»º
  build-macos:
    name: ğŸ–¥ï¸ Build macOS
    runs-on: macos-latest
    needs: [flutter-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ğŸ–¥ï¸ Build macOS
      run: flutter build macos --release
    
    - name: ğŸ“ Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: build/macos/Build/Products/Release/ball_scout.app
        retention-days: 30

  # éƒ¨ç½²åˆ°GitHub Pages (Web)
  deploy-web:
    name: ğŸš€ Deploy Web to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-web, deno-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ Download web artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: ./web
    
    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“ Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./web
    
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # å®¹å™¨åŒ–éƒ¨ç½² (å¯é€‰)
  deploy-docker:
    name: ğŸ³ Build and Deploy Docker
    runs-on: ubuntu-latest
    needs: [build-web, deno-test]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download web artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: ./build/web
    
    - name: ğŸ”‘ Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ball-scout:latest
          ${{ secrets.DOCKER_USERNAME }}/ball-scout:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # å‘å¸ƒé€šçŸ¥
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-web]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¢ Send success notification
      if: needs.deploy-web.result == 'success'
      run: |
        echo "âœ… çƒæ¢ç¤¾éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ Web: https://${{ github.repository_owner }}.github.io/ball-scout"
        echo "ğŸ“± APKä¸‹è½½: https://github.com/${{ github.repository }}/actions"
    
    - name: ğŸ“¢ Send failure notification
      if: needs.deploy-web.result == 'failure'
      run: |
        echo "âŒ çƒæ¢ç¤¾éƒ¨ç½²å¤±è´¥ï¼"
        echo "ğŸ”— æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions"

  # è‡ªåŠ¨åˆ›å»ºRelease (å½“push tagæ—¶)
  release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-web, build-android, build-ios, build-macos]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          android-build/app-release.apk
          android-build/app-release.aab
        body: |
          ## ğŸ‰ çƒæ¢ç¤¾ ${{ github.ref_name }} å‘å¸ƒ
          
          ### ğŸ“± ä¸‹è½½é“¾æ¥
          - ğŸ¤– **Android APK**: è§ä¸‹æ–¹é™„ä»¶
          - ğŸŒ **Webç‰ˆæœ¬**: https://${{ github.repository_owner }}.github.io/ball-scout
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯¦è§æäº¤è®°å½•å’ŒPRæè¿°
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - Flutter: ${{ env.FLUTTER_VERSION }}
          - Deno: ${{ env.DENO_VERSION }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
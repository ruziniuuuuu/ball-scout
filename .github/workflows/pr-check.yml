name: ðŸ” Pull Request Check

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

# Cancel previous runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.32.4'
  DENO_VERSION: '2.0.0'

jobs:
  # å¿«é€Ÿæ£€æŸ¥ - å¹¶è¡Œè¿è¡Œ
  quick-checks:
    name: ðŸš€ Quick Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ðŸ¦• Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: ${{ env.DENO_VERSION }}
    
    - name: ðŸ“¦ Get Flutter dependencies
      run: flutter pub get
    
    - name: ðŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    # å¹¶è¡Œè¿è¡Œå¤šä¸ªæ£€æŸ¥
    - name: ðŸ” Analyze Flutter code
      run: flutter analyze --fatal-infos
    
    - name: ðŸ§ª Check Deno code
      run: |
        cd backend
        deno check --unstable-temporal-api mod.ts
    
    - name: ðŸ“ Check formatting
      run: |
        if ! flutter format --set-exit-if-changed lib/; then
          echo "âŒ Flutter code is not properly formatted"
          echo "Run: flutter format lib/"
          exit 1
        fi
        
        if ! (cd backend && deno fmt --check); then
          echo "âŒ Deno code is not properly formatted"
          echo "Run: cd backend && deno fmt"
          exit 1
        fi

  # æµ‹è¯• - åŸºç¡€æµ‹è¯•
  tests:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: quick-checks
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ðŸ¦• Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: ${{ env.DENO_VERSION }}
    
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ðŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ðŸ§ª Run Flutter tests
      run: flutter test --no-sound-null-safety
    
    - name: ðŸ§ª Run Deno tests
      run: |
        cd backend
        deno test --allow-net --allow-read --allow-env

  # æž„å»ºæ£€æŸ¥ - ç¡®ä¿å¯ä»¥æˆåŠŸæž„å»º
  build-check:
    name: ðŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    needs: quick-checks
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ðŸ—ï¸ Build generated files
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: ðŸŒ Test web build
      run: flutter build web --release --no-tree-shake-icons
    
    - name: ðŸ“± Test Android build (debug)
      run: flutter build apk --debug

  # PRä¿¡æ¯æ”¶é›†
  pr-info:
    name: ðŸ“‹ PR Information
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ“Š Analyze PR changes
      run: |
        echo "## ðŸ“‹ PRåˆ†æžæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡ä¿®æ”¹æ–‡ä»¶
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
        FLUTTER_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(dart)$' | wc -l || echo "0")
        DENO_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|js)$' | wc -l || echo "0")
        
        echo "### ðŸ“ æ–‡ä»¶å˜æ›´ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¦ Flutteræ–‡ä»¶: $FLUTTER_FILES" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¦• Denoæ–‡ä»¶: $DENO_FILES" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ æ€»æ–‡ä»¶æ•°: $(echo "$CHANGED_FILES" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šå…³æ³¨
        if echo "$CHANGED_FILES" | grep -q "pubspec.yaml"; then
          echo "âš ï¸ **æ³¨æ„**: pubspec.yamlå·²ä¿®æ”¹ï¼Œè¯·ç¡®ä¿ä¾èµ–æ›´æ–°æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
        fi
        
        if echo "$CHANGED_FILES" | grep -q "deno.json"; then
          echo "âš ï¸ **æ³¨æ„**: deno.jsonå·²ä¿®æ”¹ï¼Œè¯·ç¡®ä¿é…ç½®æ›´æ–°æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸ” å˜æ›´æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "$CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # æ£€æŸ¥ç»“æžœæ±‡æ€»
  pr-check-result:
    name: âœ… PR Check Result
    runs-on: ubuntu-latest
    needs: [quick-checks, tests, build-check, pr-info]
    if: always()
    
    steps:
    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸŽ¯ PRæ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.quick-checks.result }}" == "success" && "${{ needs.tests.result }}" == "success" && "${{ needs.build-check.result }}" == "success" ]]; then
          echo "âœ… **æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¥PRå¯ä»¥å®‰å…¨åˆå¹¶ ðŸš€" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **å­˜åœ¨é—®é¢˜éœ€è¦ä¿®å¤**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ£€æŸ¥çŠ¶æ€:" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç æ£€æŸ¥: ${{ needs.quick-checks.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•: ${{ needs.tests.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»º: ${{ needs.build-check.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi 